<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ITNR ‚Äì Chat</title>
  <style>
    :root { --bg:#0f172a; --panel:#0b1220; --card:#111827; --muted:#94a3b8; --pri:#60a5fa; --accent:#1d4ed8; --border:#1f2937; --text:#e5e7eb; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial; background:var(--bg); color:var(--text); }
    header { position:sticky; top:0; background:linear-gradient(180deg,#0f172a,#0f172aeb); border-bottom:1px solid var(--border); padding:12px 16px; display:flex; align-items:center; gap:10px; z-index:100; }
    header h1 { margin:0; font-size:16px; letter-spacing:.3px; }
    .wrap { max-width:980px; margin:0 auto; padding:12px 16px 80px; }
    .chat { display:flex; flex-direction:column; gap:12px; }
    .bubble { padding:12px 14px; border-radius:14px; max-width:80%; box-shadow: 0 2px 16px rgba(0,0,0,.15); }
    .me { align-self:flex-end; background:#1f2937; }
    .bot { align-self:flex-start; background:var(--panel); border:1px solid var(--border); }
    .muted { color:var(--muted); font-size:12px; }
    .cards { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:14px; margin-top:8px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:14px; }
    .pill { display:inline-block; border:1px solid #334155; border-radius:999px; padding:2px 8px; margin-right:6px; font-size:12px; background:#0b1220; }
    .legs { margin-top:8px; font-size:13px; line-height:1.5; }
    .footer { position:fixed; left:0; right:0; bottom:0; background:linear-gradient(180deg,transparent, #0f172a 30%, #0f172a); padding:16px; }
    form { display:flex; gap:8px; max-width:980px; margin:0 auto; }
    input[type="text"] { flex:1; padding:12px 14px; border-radius:14px; border:1px solid var(--border); background:var(--panel); color:var(--text); }
    button { padding:12px 16px; border-radius:12px; border:0; background:var(--accent); color:#fff; font-weight:600; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .loader { width:28px; height:28px; border:3px solid #1f2937; border-top-color: var(--pri); border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    a.btn { display:inline-block; margin-top:10px; background:#0b1220; border:1px solid #334155; padding:8px 10px; border-radius:10px; text-decoration:none; color:var(--pri); font-weight:600; }
  </style>
</head>
<body>
  <header>
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
      <path d="M3 6h10l2 3h6M3 18h10l2-3h6" stroke="#60a5fa" stroke-width="1.5" stroke-linecap="round"/>
    </svg>
    <h1>ITNR ‚Äì Chat de recherche de vols</h1>
    <div class="muted" style="margin-left:auto">MVP</div>
  </header>

  <div class="wrap">
    <div id="chat" class="chat">
      <div class="bubble bot">
        üëã Dis-moi par ex. <i>‚ÄúTrouve-moi un AR Paris Bangkok entre janvier et f√©vrier, ~3 semaines, le moins cher‚Äù.</i>
      </div>
    </div>
  </div>

  <div class="footer">
    <form id="form">
      <input id="msg" type="text" placeholder="√âcris ta demande..." autocomplete="off" required />
      <button id="send" type="submit">Envoyer</button>
    </form>
  </div>

<script>
const API_BASE = "https://itnr-fastapi-mvp.onrender.com"; // ‚Üê adapte si besoin
const chatEl = document.getElementById('chat');
const form = document.getElementById('form');
const msgInput = document.getElementById('msg');
const sendBtn = document.getElementById('send');

function addBubble(text, who='bot') {
  const b = document.createElement('div');
  b.className = 'bubble ' + (who === 'me' ? 'me' : 'bot');
  b.innerHTML = text;
  chatEl.appendChild(b);
  window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
  return b;
}

function hhmm(mins){
  const h = Math.floor(mins/60), m = mins%60;
  return h + 'h' + String(m).padStart(2,'0');
}

function euro(v){ return '‚Ç¨' + (Math.round(v*100)/100).toFixed(2); }

function buildGoogleFlightsSearchURL(origin, dest, dep, ret) {
  const q = `flights ${origin} to ${dest} ${dep} return ${ret}`;
  return `https://www.google.com/travel/flights?q=${encodeURIComponent(q)}&hl=fr`;
}

function renderCards(result, meta){
  const grid = document.createElement('div'); grid.className = 'cards';
  const items = [
    ['üí∏ Le moins cher', result.cheapest],
    ['üëç Recommand√©', result.recommended],
    ['‚úàÔ∏è Direct', result.direct],
  ];
  const origin = meta?.searched?.originLocationCode || (result.cheapest?.legs?.[0]?.from) || '';
  const dest   = meta?.searched?.destinationLocationCode || (result.cheapest?.legs?.[0]?.to)   || '';
  const dep = meta?.searched?.departureDate || '';
  const ret = meta?.searched?.returnDate || '';

  for (const [title, data] of items) {
    const card = document.createElement('div'); card.className = 'card';
    const h = document.createElement('div'); h.style.fontWeight='700'; h.style.marginBottom='6px'; h.textContent = title;
    card.appendChild(h);

    if (!data) {
      const m = document.createElement('div'); m.className='muted'; m.textContent = 'Aucune offre trouv√©e.';
      card.appendChild(m);
      grid.appendChild(card);
      continue;
    }
    const top = document.createElement('div');
    top.innerHTML = `
      <span class="pill">Total: ${euro(data.price_total_eur)}</span>
      <span class="pill">‚Ç¨/pax: ${euro(data.price_per_pax_eur)}</span>
      <span class="pill">Escales max: ${data.stops_max}</span>
      <span class="pill">Dur√©e: ${data.duration_total_hhmm || hhmm(data.duration_total_min)}</span>
      <div class="muted" style="margin-top:6px">Compagnies: ${(data.carriers||[]).join(', ')}</div>
    `;
    card.appendChild(top);

    const legs = document.createElement('div'); legs.className='legs';
    (data.legs || []).forEach((g,i)=>{
      const div = document.createElement('div');
      div.textContent = `(${i===0?'Aller':'Retour'}) ${g.from} ‚Üí ${g.to} ‚Äî d√©part ${g.dep}, arriv√©e ${g.arr} ‚Äî escales: ${g.stops}`;
      legs.appendChild(div);
    });
    card.appendChild(legs);

    const link = document.createElement('a'); link.className='btn'; link.target='_blank';
    link.textContent = 'Voir billets';
    link.href = buildGoogleFlightsSearchURL(origin, dest, dep, ret);
    card.appendChild(link);

    grid.appendChild(card);
  }
  return grid;
}

form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const text = msgInput.value.trim(); if (!text) return;
  addBubble(text, 'me');
  msgInput.value=''; msgInput.focus();
  sendBtn.disabled = true;
  const loader = addBubble('<div class="loader"></div>');

  try {
    const r1 = await fetch(API_BASE + '/chat', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ message: text })
    });
    const d1 = await r1.json();
    if (!r1.ok) throw new Error(d1.detail || JSON.stringify(d1));

    const payload = {
      originCity: d1.parsed.originCity,
      destinationCity: d1.parsed.destinationCity,
      departureDate: d1.parsed.departureDate,
      returnDate: d1.parsed.returnDate,
      passengers: d1.parsed.passengers || { adults:1, children:0, infants:0 },
      cabin: "ECONOMY",
      maxStops: d1.parsed.maxStops ?? 1,
      budgetPerPaxEUR: d1.parsed.budgetPerPaxEUR
    };
    const r2 = await fetch(API_BASE + '/search', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const d2 = await r2.json();
    if (!r2.ok) throw new Error(d2.error || JSON.stringify(d2));

    const parsedTxt = `üß≠ Crit√®res d√©tect√©s: <b>${payload.originCity}</b> ‚Üí <b>${payload.destinationCity}</b>, ` +
                      `Aller: <b>${payload.departureDate}</b>, Retour: <b>${payload.returnDate}</b>, ` +
                      `Pax: <b>${payload.passengers.adults}</b>, Escales max: <b>${payload.maxStops}</b>` +
                      (payload.budgetPerPaxEUR ? `, Budget/pax: <b>${euro(payload.budgetPerPaxEUR)}</b>` : '');
    loader.outerHTML = '';
    const wrap = document.createElement('div'); wrap.className = 'bubble bot';
    wrap.innerHTML = parsedTxt;
    wrap.appendChild(renderCards(d2.results || {}, d2.meta || {}));
    chatEl.appendChild(wrap);
    window.scrollTo({ top: document.body.scrollHeight, behavior:'smooth' });

  } catch (err) {
    loader.outerHTML = '';
    addBubble('‚ö†Ô∏è ' + (err?.message || err), 'bot');
  } finally {
    sendBtn.disabled = false;
  }
});
</script>
</body>
</html>
