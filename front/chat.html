<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ITNR ‚Äì Chat</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="config.js"></script>
</head>
<body>
  <header class="header">
    <div class="container row">
      <div class="brand">
        <svg width="24" height="24" viewBox="0 0 24 24"><path d="M3 6h10l2 3h6M3 18h10l2-3h6" stroke="#60a5fa" stroke-width="1.5" fill="none" stroke-linecap="round"/></svg>
        <h1>ITNR ‚Äì Chat de recherche de vols</h1>
      </div>
      <nav class="nav">
        <a href="index.html">üè† Accueil</a>
      </nav>
    </div>
  </header>

  <main class="section">
    <div class="container">
      <div id="chat" class="chat">
        <div class="bubble bot">
          üëã Dis-moi par ex. <i>‚ÄúTrouve-moi un AR Paris Bangkok entre janvier et f√©vrier, ~3 semaines, le moins cher‚Äù.</i>
        </div>
      </div>
    </div>
  </main>

  <div class="footer">
    <form id="form" class="form-inline">
      <input id="msg" class="input" type="text" placeholder="√âcris ta demande..." autocomplete="off" required />
      <button id="send" class="btn" type="submit">Envoyer</button>
    </form>
  </div>

  <div id="toast" class="toast" style="display:none"></div>

<script>
const API_BASE = window.API_BASE || "";

const euro = v => "‚Ç¨" + (Math.round(v * 100) / 100).toFixed(2);
const hhmm = mins => `${Math.floor(mins/60)}h${String(mins%60).padStart(2,"0")}`;
const gflights = (origin, dest, dep, ret) =>
  `https://www.google.com/travel/flights?q=${encodeURIComponent(`flights ${origin} to ${dest} ${dep} return ${ret}`)}&hl=fr`;

function toast(msg, ms=2800) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.style.display = 'block';
  setTimeout(()=> t.style.display = 'none', ms);
}
function addBubble(text, who='bot') {
  const b = document.createElement('div');
  b.className = 'bubble ' + (who === 'me' ? 'me' : 'bot');
  b.innerHTML = text;
  document.getElementById('chat').appendChild(b);
  window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
  return b;
}
function renderCards(result, meta){
  const grid = document.createElement('div'); grid.className = 'cards';
  const items = [
    ['üí∏ Le moins cher', result.cheapest],
    ['üëç Recommand√©', result.recommended],
    ['‚úàÔ∏è Direct', result.direct],
  ];
  const origin = meta?.searched?.originLocationCode || (result.cheapest?.legs?.[0]?.from) || '';
  const dest   = meta?.searched?.destinationLocationCode || (result.cheapest?.legs?.[0]?.to)   || '';
  const dep = meta?.searched?.departureDate || '';
  const ret = meta?.searched?.returnDate || '';

  for (const [title, data] of items) {
    const card = document.createElement('div'); card.className = 'card';
    const h = document.createElement('div'); h.style.fontWeight='800'; h.style.marginBottom='6px'; h.textContent = title;
    card.appendChild(h);

    if (!data) {
      const m = document.createElement('div'); m.className='small'; m.textContent = 'Aucune offre trouv√©e.';
      card.appendChild(m);
      grid.appendChild(card);
      continue;
    }
    const top = document.createElement('div');
    top.innerHTML = `
      <span class="kpi">Total: ${euro(data.price_total_eur)}</span>
      <span class="kpi">‚Ç¨/pax: ${euro(data.price_per_pax_eur)}</span>
      <span class="kpi">Escales max: ${data.stops_max}</span>
      <span class="kpi">Dur√©e: ${data.duration_total_hhmm || hhmm(data.duration_total_min)}</span>
      <div class="small" style="margin-top:6px">Compagnies: ${(data.carriers||[]).join(', ') || '‚Äî'}</div>
    `;
    card.appendChild(top);

    const legs = document.createElement('div'); legs.className='legs';
    (data.legs || []).forEach((g,i)=>{
      const div = document.createElement('div');
      div.textContent = `(${i===0?'Aller':'Retour'}) ${g.from} ‚Üí ${g.to} ‚Äî d√©part ${g.dep}, arriv√©e ${g.arr} ‚Äî escales: ${g.stops}`;
      legs.appendChild(div);
    });
    card.appendChild(legs);

    const link = document.createElement('a'); link.className='btn-link'; link.target='_blank';
    link.textContent = 'Voir billets';
    link.href = gflights(origin, dest, dep, ret);
    card.appendChild(link);

    grid.appendChild(card);
  }
  return grid;
}

document.getElementById('form').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const text = document.getElementById('msg').value.trim(); if (!text) return;
  addBubble(text, 'me');
  document.getElementById('msg').value=''; document.getElementById('msg').focus();
  const btn = document.getElementById('send'); btn.disabled = true;
  const loader = addBubble('<div class="loader"></div>');

  try {
    const r1 = await fetch(API_BASE + '/chat', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ message: text })
    });
    const d1 = await r1.json();
    if (!r1.ok) throw new Error(d1.detail || JSON.stringify(d1));

    const payload = {
      originCity: d1.parsed.originCity,
      destinationCity: d1.parsed.destinationCity,
      departureDate: d1.parsed.departureDate,
      returnDate: d1.parsed.returnDate,
      passengers: d1.parsed.passengers || { adults:1, children:0, infants:0 },
      cabin: "ECONOMY",
      maxStops: d1.parsed.maxStops ?? 1,
      budgetPerPaxEUR: d1.parsed.budgetPerPaxEUR
    };
    const r2 = await fetch(API_BASE + '/search', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const d2 = await r2.json();
    if (!r2.ok) throw new Error(d2.error || JSON.stringify(d2));

    loader.outerHTML = '';
    const parsedTxt = `üß≠ Crit√®res d√©tect√©s: <b>${payload.originCity}</b> ‚Üí <b>${payload.destinationCity}</b>, `
      + `Aller: <b>${payload.departureDate}</b>, Retour: <b>${payload.returnDate}</b>, `
      + `Pax: <b>${payload.passengers.adults}</b>, Escales max: <b>${payload.maxStops}</b>`
      + (payload.budgetPerPaxEUR ? `, Budget/pax: <b>${euro(payload.budgetPerPaxEUR)}</b>` : '')
      + (d2.meta?.llm ? ` <span class="small">(moteur: ${d2.meta.llm})</span>` : '');
    const wrap = addBubble(parsedTxt, 'bot');
    wrap.appendChild(renderCards(d2.results || {}, d2.meta || {}));
    window.scrollTo({ top: document.body.scrollHeight, behavior:'smooth' });
  } catch (err) {
    loader.outerHTML = '';
    addBubble('‚ö†Ô∏è ' + (err?.message || err), 'bot');
    toast("Erreur: " + (err?.message || err), 4000);
  } finally {
    btn.disabled = false;
  }
});
</script>
</body>
</html>
