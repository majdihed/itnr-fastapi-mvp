<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ITNR ‚Äì Recherche de vols</title>
  <link rel="icon" href="itnr_mark.svg" type="image/svg+xml">
  <link rel="stylesheet" href="styles.css?v=20250901" />
  <script src="config.js?v=20250901"></script>
  <!-- Calendrier (cross navigateur) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</head>
<body>
  <header class="header">
    <div class="container row">
      <div class="brand">
        <img src="itnr.svg" alt="ITNR" width="150" height="34" />
        <h1 style="display:none">ITNR</h1>
      </div>
      <nav class="nav">
        <a href="chat.html">üëã Chat</a>
      </nav>
    </div>
  </header>

  <main class="section">
    <div class="container grid">
      <section class="card">
        <h2 style="margin-top:0">Param√®tres</h2>

        <div class="radios">
          <label><input type="radio" name="dateMode" value="exact" checked/> Dates exactes</label>
          <label><input type="radio" name="dateMode" value="period"/> Mois + dur√©e</label>
        </div>

        <form id="form" novalidate>
          <div class="grid-2">
            <div class="ac-wrap">
              <label>Ville de d√©part</label>
              <input id="originCity" class="input" placeholder="Paris" autocomplete="off" required />
              <div id="ac-origin" class="ac-list"></div>
            </div>
            <div class="ac-wrap">
              <label>Ville d'arriv√©e</label>
              <input id="destinationCity" class="input" placeholder="Bangkok" autocomplete="off" required />
              <div id="ac-dest" class="ac-list"></div>
            </div>
          </div>

          <div id="dates-exact" class="grid-2" style="margin-top:12px">
            <div>
              <label>Date aller</label>
              <input id="departureDate" class="input" type="text" placeholder="YYYY-MM-DD" required />
            </div>
            <div>
              <label>Date retour</label>
              <input id="returnDate" class="input" type="text" placeholder="YYYY-MM-DD" required />
            </div>
          </div>

          <div id="dates-period" class="grid-2 hidden" style="margin-top:12px">
            <div>
              <label>Mois</label>
              <input id="monthStart" class="input" type="month" />
            </div>
            <div>
              <label>Dur√©e (jours)</label>
              <input id="durationDays" class="input" type="number" min="1" step="1" value="21" />
            </div>
          </div>

          <div class="grid-3" style="margin-top:12px">
            <div>
              <label>Adultes</label>
              <div class="stepper">
                <button type="button" data-step="-1" data-target="adults">‚àí</button>
                <input id="adults" type="number" min="1" value="1" />
                <button type="button" data-step="+1" data-target="adults">+</button>
              </div>
            </div>
            <div>
              <label>Enfants (2‚Äì11 ans)</label>
              <div class="stepper">
                <button type="button" data-step="-1" data-target="children">‚àí</button>
                <input id="children" type="number" min="0" value="0" />
                <button type="button" data-step="+1" data-target="children">+</button>
              </div>
            </div>
            <div>
              <label>B√©b√©s (&lt; 2 ans)</label>
              <div class="stepper">
                <button type="button" data-step="-1" data-target="infants">‚àí</button>
                <input id="infants" type="number" min="0" value="0" />
                <button type="button" data-step="+1" data-target="infants">+</button>
              </div>
              <div class="small">Recommand√© : b√©b√©s ‚â§ adultes.</div>
            </div>
          </div>

          <div class="grid-3" style="margin-top:12px">
            <div>
              <label>Escales max</label>
              <select id="maxStops" class="input">
                <option value="0">0 (direct)</option>
                <option value="1" selected>1</option>
                <option value="2">2</option>
              </select>
            </div>
            <div>
              <label>Budget / personne (‚Ç¨)</label>
              <input id="budget" class="input" type="number" min="0" step="1" placeholder="500" />
            </div>
            <div>
              <label>Dates flexibles</label>
              <div class="row">
                <label style="margin:0"><input id="flexToggle" type="checkbox" /> ¬±</label>
                <select id="flexDays" class="input" disabled>
                  <option value="1">1 jour</option>
                  <option value="2">2 jours</option>
                  <option value="3" selected>3 jours</option>
                </select>
              </div>
            </div>
          </div>

          <div style="margin-top:14px">
            <button class="btn" type="submit">Rechercher</button>
          </div>
        </form>
      </section>

      <section class="card">
        <h2 style="margin-top:0">R√©sultats</h2>
        <div id="hint" class="small">Les cartes ‚Äúüí∏ Le moins cher / üëç Recommand√© / ‚úàÔ∏è Direct‚Äù appara√Ætront ici.</div>
        <div id="results" class="cards" style="margin-top:10px"></div>
      </section>
    </div>
  </main>

  <div id="toast" class="toast" style="display:none"></div>

<script>
const API = (window.API_BASE || "");
const euro = v => "‚Ç¨" + (Math.round(v * 100) / 100).toFixed(2);
const hhmm = mins => `${Math.floor(mins/60)}h${String(mins%60).padStart(2,"0")}`;
const todayISO = () => new Date().toISOString().slice(0,10);

// ---- calendrier
(function initDates(){
  const depPicker = flatpickr("#departureDate", {
    dateFormat: "Y-m-d",
    minDate: "today",
    onChange: (sel) => { if (sel[0]) retPicker.set("minDate", sel[0]); }
  });
  const retPicker = flatpickr("#returnDate", {
    dateFormat: "Y-m-d",
    minDate: "today"
  });

  const radios = document.querySelectorAll('input[name="dateMode"]');
  const exact = document.getElementById('dates-exact');
  const period = document.getElementById('dates-period');
  radios.forEach(r => r.addEventListener('change', ()=>{
    const mode = document.querySelector('input[name="dateMode"]:checked').value;
    exact.classList.toggle('hidden', mode !== 'exact');
    period.classList.toggle('hidden', mode !== 'period');
  }));
})();

// ---- flex toggle
document.getElementById('flexToggle').addEventListener('change', (e)=>{
  document.getElementById('flexDays').disabled = !e.target.checked;
});

// ---- steppers
document.querySelectorAll('.stepper button').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const target = document.getElementById(btn.dataset.target);
    const step = btn.dataset.step === '+1' ? 1 : -1;
    const next = Math.max(parseInt(target.min||'0',10), (parseInt(target.value||'0',10) + step));
    target.value = next;
  });
});

// ---- autocomplete
function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
function bindAutocomplete(inputId, listId){
  const input = document.getElementById(inputId);
  const list = document.getElementById(listId);

  async function search(term){
    if (!term || term.trim().length < 2) { list.style.display='none'; list.innerHTML=''; return; }
    try {
      const r = await fetch(`${API}/locations?q=${encodeURIComponent(term.trim())}`);
      const j = await r.json();
      list.innerHTML = '';
      (j.items||[]).forEach(it=>{
        const li = document.createElement('div'); li.className='ac-item';
        li.textContent = `${it.label}`;
        li.addEventListener('click', ()=>{
          input.value = (it.cityName || it.name || '').split(' ‚Äì ')[0];
          list.style.display='none'; list.innerHTML='';
        });
        list.appendChild(li);
      });
      list.style.display = (list.children.length ? 'block' : 'none');
    } catch(e){ list.style.display='none'; list.innerHTML=''; }
  }
  input.addEventListener('input', debounce(()=>search(input.value), 200));
  input.addEventListener('focus', ()=>{ if (list.children.length) list.style.display='block'; });
  document.addEventListener('click', (ev)=>{ if (!list.contains(ev.target) && ev.target!==input) list.style.display='none'; });
}
bindAutocomplete('originCity','ac-origin');
bindAutocomplete('destinationCity','ac-dest');

// ---- toast
function toast(msg, ms=2800) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.style.display = 'block';
  setTimeout(()=> t.style.display = 'none', ms);
}

// ---- cartes
function makeCard(title, data, meta, options = {}){
  const el = document.createElement('div'); el.className = 'card';
  const header = document.createElement('div'); header.style.fontWeight='800';
  header.textContent = title; el.appendChild(header);

  if (!data) {
    const alt = options.altIfMissing;
    if (alt) {
      const small = document.createElement('div'); small.className='small';
      small.textContent = "Aucun vol direct. Meilleure option avec escale(s) :";
      el.appendChild(small);
      data = alt;
    } else {
      const m = document.createElement('div'); m.className='small'; m.textContent = 'Aucune offre trouv√©e.';
      el.appendChild(m); return el;
    }
  }

  const top = document.createElement('div'); top.style.margin = '6px 0';
  top.innerHTML = `
    <span class="kpi">Total: ${euro(data.price_total_eur)}</span>
    <span class="kpi">‚Ç¨/pax: ${euro(data.price_per_pax_eur)}</span>
    <span class="kpi">Escales: ${data.stops_max}</span>
    <span class="kpi">Dur√©e: ${data.duration_total_hhmm}</span>
    <div class="small" style="margin-top:6px">Compagnies: ${(data.carriers||[]).join(', ') || '‚Äî'}</div>
  `;
  el.appendChild(top);

  const legs = document.createElement('div'); legs.className='legs';
  (data.legs||[]).forEach((g,i)=>{
    const div = document.createElement('div');
    div.textContent = `(${i===0?'Aller':'Retour'}) ${g.from} ‚Üí ${g.to} ‚Äî d√©part ${g.dep} ‚Äî arriv√©e ${g.arr} ‚Äî escales: ${g.stops}`;
    legs.appendChild(div);
  });
  el.appendChild(legs);

  const origin = meta?.searched?.originLocationCode || (data?.legs?.[0]?.from) || '';
  const dest   = meta?.searched?.destinationLocationCode || (data?.legs?.[0]?.to)   || '';
  const dep    = meta?.searched?.departureDate || '';
  const ret    = meta?.searched?.returnDate || '';
  const a = document.createElement('a'); a.className='btn-link'; a.target='_blank';
  a.href = `https://www.google.com/travel/flights?q=${encodeURIComponent(`flights ${origin} to ${dest} ${dep} return ${ret}`)}&hl=fr`;
  a.textContent = 'Voir billets';
  el.appendChild(a);

  return el;
}

// ---- submit
document.getElementById('form').addEventListener('submit', async (e)=>{
  e.preventDefault();

  const originCity = document.getElementById('originCity').value.trim();
  const destinationCity = document.getElementById('destinationCity').value.trim();
  if (!originCity || !destinationCity) { toast("Renseigne les villes."); return; }

  const mode = document.querySelector('input[name="dateMode"]:checked').value;
  let departureDate = "", returnDate = "", period = null;
  if (mode === 'exact') {
    departureDate = document.getElementById('departureDate').value;
    returnDate = document.getElementById('returnDate').value;
    if (!departureDate || !returnDate) { toast("Compl√®te les dates."); return; }
  } else {
    const monthStart = document.getElementById('monthStart').value; // YYYY-MM
    const durationDays = parseInt(document.getElementById('durationDays').value || '0', 10);
    if (!monthStart || !durationDays) { toast("Compl√®te le mois et la dur√©e."); return; }
    period = { start: monthStart + "-01", durationDays };
  }

  const adults = Math.max(1, parseInt(document.getElementById('adults').value||'1',10));
  const children = Math.max(0, parseInt(document.getElementById('children').value||'0',10));
  const infants = Math.max(0, parseInt(document.getElementById('infants').value||'0',10));
  if (infants > adults) { toast("B√©b√©s ‚â§ adultes recommand√©."); }

  let flexDays = undefined;
  if (document.getElementById('flexToggle').checked) flexDays = parseInt(document.getElementById('flexDays').value, 10);

  const payload = {
    originCity, destinationCity,
    passengers: { adults, children, infants },
    cabin: "ECONOMY",
    maxStops: parseInt(document.getElementById('maxStops').value,10)
  };
  if (mode === 'exact') { payload.departureDate = departureDate; payload.returnDate = returnDate; }
  else { payload.period = period; }
  const budget = document.getElementById('budget').value; if (budget) payload.budgetPerPaxEUR = parseFloat(budget);
  if (flexDays !== undefined) payload.flexDays = flexDays;

  const btn = e.submitter; btn.disabled = true; btn.textContent = "Recherche...";
  const results = document.getElementById('results'); const hint = document.getElementById('hint');
  results.innerHTML = ""; hint.textContent = "Chargement...";

  try {
    const res = await fetch(API + "/search", {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || data.detail || JSON.stringify(data));

    const cheapest = data.results?.cheapest || null;
    const recommended = data.results?.recommended || null;
    const direct = data.results?.direct || null;

    results.appendChild(makeCard("üí∏ Le moins cher", cheapest, data.meta));
    results.appendChild(makeCard("üëç Recommand√©", recommended, data.meta));
    results.appendChild(makeCard("‚úàÔ∏è Direct", direct, data.meta, { altIfMissing: cheapest || recommended }));

    hint.textContent = `Trouv√©s: ${data.meta.kept}/${data.meta.totalCandidates}`;
  } catch (err) {
    hint.textContent = "Une erreur est survenue.";
    toast("Erreur : " + (err?.message || err), 4500);
  } finally {
    btn.disabled = false; btn.textContent = "Rechercher";
  }
});
</script>
</body>
</html>
