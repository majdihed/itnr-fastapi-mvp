<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ITNR</title>
  <link rel="icon" href="itnr_mark.svg" type="image/svg+xml">
  <!-- cache-buster pour forcer le navigateur √† recharger -->
  <link rel="stylesheet" href="styles.css?v=20250901" />
  <script src="config.js?v=20250901"></script>
</head>
<body>
  <header class="header">
    <div class="container row">
      <div class="brand">
        <svg width="24" height="24" viewBox="0 0 24 24"><path d="M3 6h10l2 3h6M3 18h10l2-3h6" stroke="#60a5fa" stroke-width="1.5" fill="none" stroke-linecap="round"/></svg>
        <h1>ITNR ‚Äì Recherche de vols</h1>
      </div>
      <nav class="nav">
        <a href="chat.html">üëã Chat</a>
      </nav>
    </div>
  </header>

  <main class="section">
    <div class="container grid">
      <section class="card">
        <h2 style="margin-top:0">Formulaire simple</h2>
        <form id="form" novalidate>
          <div class="grid-2">
            <div>
              <label>Ville de d√©part</label>
              <input id="originCity" class="input" placeholder="Paris" required />
            </div>
            <div>
              <label>Ville d'arriv√©e</label>
              <input id="destinationCity" class="input" placeholder="Bangkok" required />
            </div>
          </div>
          <div class="grid-2" style="margin-top:12px">
            <div>
              <label>Date aller</label>
              <input id="departureDate" class="input" type="date" required />
            </div>
            <div>
              <label>Date retour</label>
              <input id="returnDate" class="input" type="date" required />
            </div>
          </div>
          <div class="grid-3" style="margin-top:12px">
            <div>
              <label>Adultes</label>
              <input id="adults" class="input" type="number" min="1" value="1" />
            </div>
            <div>
              <label>Escales max</label>
              <select id="maxStops" class="input">
                <option value="0">0 (direct)</option>
                <option value="1" selected>1</option>
                <option value="2">2</option>
              </select>
            </div>
            <div>
              <label>Budget / personne (‚Ç¨)</label>
              <input id="budget" class="input" type="number" min="0" step="1" placeholder="900" />
            </div>
          </div>
          <div style="margin-top:14px">
            <button class="btn" type="submit">Rechercher</button>
          </div>
        </form>
      </section>

      <section class="card">
        <h2 style="margin-top:0">R√©sultats</h2>
        <div id="hint" class="small">Les cartes ‚Äúüí∏ Le moins cher / üëç Recommand√© / ‚úàÔ∏è Direct‚Äù appara√Ætront ici.</div>
        <div id="results" class="cards" style="margin-top:10px"></div>
      </section>
    </div>
  </main>

  <div id="toast" class="toast" style="display:none"></div>

<script>
const API_URL = (window.API_BASE || "") + "/search";

const euro = v => "‚Ç¨" + (Math.round(v * 100) / 100).toFixed(2);
const hhmm = mins => `${Math.floor(mins/60)}h${String(mins%60).padStart(2,"0")}`;
const gflights = (origin, dest, dep, ret) =>
  `https://www.google.com/travel/flights?q=${encodeURIComponent(`flights ${origin} to ${dest} ${dep} return ${ret}`)}&hl=fr`;

function toast(msg, ms=2800) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.style.display = 'block';
  setTimeout(()=> t.style.display = 'none', ms);
}

function card(title, data, meta) {
  const el = document.createElement('div'); el.className = 'card';
  const h = document.createElement('div'); h.style.fontWeight='800'; h.textContent = title; el.appendChild(h);

  if (!data) {
    const m = document.createElement('div'); m.className = 'small'; m.textContent = 'Aucune offre trouv√©e.'; el.appendChild(m);
    return el;
  }

  const top = document.createElement('div'); top.style.margin = '6px 0';
  top.innerHTML = `
    <span class="kpi">Total: ${euro(data.price_total_eur)}</span>
    <span class="kpi">‚Ç¨/pax: ${euro(data.price_per_pax_eur)}</span>
    <span class="kpi">Escales max: ${data.stops_max}</span>
    <span class="kpi">Dur√©e: ${data.duration_total_hhmm || hhmm(data.duration_total_min)}</span>
    <div class="small" style="margin-top:6px">Compagnies: ${(data.carriers||[]).join(', ') || '‚Äî'}</div>
  `;
  el.appendChild(top);

  const legs = document.createElement('div'); legs.className = 'legs';
  (data.legs || []).forEach((g,i)=>{
    const d = document.createElement('div');
    d.textContent = `(${i===0?'Aller':'Retour'}) ${g.from} ‚Üí ${g.to} ‚Äî d√©part ${g.dep}, arriv√©e ${g.arr} ‚Äî escales: ${g.stops}`;
    legs.appendChild(d);
  });
  el.appendChild(legs);

  const origin = meta?.searched?.originLocationCode || data?.legs?.[0]?.from || '';
  const dest   = meta?.searched?.destinationLocationCode || data?.legs?.[0]?.to || '';
  const dep    = meta?.searched?.departureDate || '';
  const ret    = meta?.searched?.returnDate || '';

  const a = document.createElement('a'); a.className = 'btn-link'; a.target = '_blank';
  a.href = gflights(origin, dest, dep, ret);
  a.textContent = 'Voir billets';
  el.appendChild(a);

  return el;
}

document.getElementById('form').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const originCity = document.getElementById('originCity').value.trim();
  const destinationCity = document.getElementById('destinationCity').value.trim();
  const departureDate = document.getElementById('departureDate').value;
  const returnDate = document.getElementById('returnDate').value;
  const adults = parseInt(document.getElementById('adults').value || '1', 10);
  const maxStops = parseInt(document.getElementById('maxStops').value, 10);
  const budget = document.getElementById('budget').value;

  if (!originCity || !destinationCity || !departureDate || !returnDate) {
    toast("Merci de compl√©ter tous les champs requis.");
    return;
  }
  const payload = {
    originCity, destinationCity, departureDate, returnDate,
    passengers: { adults, children: 0, infants: 0 },
    cabin: "ECONOMY",
    maxStops,
  };
  if (budget) payload.budgetPerPaxEUR = parseFloat(budget);

  const btn = e.submitter; btn.disabled = true; btn.textContent = "Recherche...";
  const results = document.getElementById('results');
  const hint = document.getElementById('hint');
  results.innerHTML = ""; hint.textContent = "Chargement des meilleures options...";
  try {
    const res = await fetch(API_URL, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || data.detail || JSON.stringify(data));
    results.appendChild(card("üí∏ Le moins cher", data.results.cheapest, data.meta));
    results.appendChild(card("üëç Recommand√©", data.results.recommended, data.meta));
    results.appendChild(card("‚úàÔ∏è Direct", data.results.direct, data.meta));
    hint.textContent = `Trouv√©s: ${data.meta.kept}/${data.meta.totalCandidates} candidats ‚Äî moteur: ${data.meta.llm || 'ok'}`;
  } catch (err) {
    hint.textContent = "Une erreur est survenue.";
    toast("Erreur de recherche : " + (err?.message || err), 4000);
  } finally {
    btn.disabled = false; btn.textContent = "Rechercher";
  }
});
</script>
</body>
</html>
